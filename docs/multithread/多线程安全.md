# 多线程安全

* [什么是线程安全？](#什么是线程安全？)
* [一共有几类线程安全问题](##一共有几类线程安全问题？)
* [各种需要考虑线程安全的情况](#各种需要考虑线程安全的情况)
* [为什么多线程会带来性能问题](#为什么多线程会带来性能问题)
* [何时会导致密集的上下文切换](#何时会导致密集的上下文切换)

## 1. 什么是线程安全？

不管业务中遇到怎样的多个线程访问某个对象或某个方法的情况，而在编程这个业务逻辑的时候，都不需要做额外的处理（也就是可以像单线程一样），程序也可以
正常运行（不会因为多线程而出错），就可以称为线程安全

## 2. 一共有几类线程安全问题？

1. 数据争用：数据读写由于同时写，会造成数据错误
2. 竞争条件：由于顺序原因依然会造成错误，例如还未写就读取了

#### 1.运行结果错误a++多线程下出现不准的请求现象

![a++](https://raw.githubusercontent.com/EruDev/md-picture/master/img/1590820553.png)

#### 2.活跃性问题：死锁 活锁 饥饿锁

![死锁](https://raw.githubusercontent.com/EruDev/md-picture/master/img/1590820570.png)

#### 3.对象发布和初始化问题

![对象发布和初始化问题](https://raw.githubusercontent.com/EruDev/md-picture/master/img/1590821673.PNG)

```markdown
举例：
    1.在构造函数中未初始化完毕就this赋值
    2.构造函数中运行线程
```

## 3.各种需要考虑线程安全的情况

1. 访问共享的变量或资源, 会有并发风险, 比如对象的属性、静态变量、共享内存、数据库等
2. 所有依赖时序的操作, 即每一步操作都是线程安全的, 还是存在并发问题, read-modify-write, check-then-act
3. 不同数据存在捆绑关系的时候, 比如IP和端口号
4. 我们使用其他类的时候, 如果对方没有声明是线程安全的, 那么大概率会存在并发问题(比如hashmap没有声明自己是线程安全的)

## 4.为什么多线程会带来性能问题

由于线程需要协作所以会引起调度, 当你的线程大于cpu的数量的时候系统就会进行分配和调度

1. 调度就会引起上下文切换
2. 什么是上下文？

操作系统的核心在cpu上对于进程进行以下的活动, 挂起一个线程将这个进程在CPU上进行对于进程包括线程进行以下活动：
- 挂起一个线程 将这个进程在CPU中的状态存储在内存中的某处
- 在内存中检索下一个进程的上下文并在cpu的寄存器恢复
- 跳到程序计数器所指的位置 恢复该进程

## 5.何时会导致密集的上下文切换

频繁竞争锁 或者IO读写阻塞